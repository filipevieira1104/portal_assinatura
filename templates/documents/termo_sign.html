{% extends "base.html" %}
{% load static %}

{% block title %}Assinatura de Termo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col">
            <h2>Assinatura de Termo de Responsabilidade</h2>
            <div class="card">
                <div class="card-header">
                    <h4>{{ termo.modelo.titulo }}</h4>
                </div>
                <div class="card-body">
                    <!-- Conteúdo do documento -->
                    <div class="documento-preview mb-4">
                        {{ termo.modelo.conteudo|safe }}
                    </div>
                    
                    <!-- Lista de equipamentos -->
                    {% if equipamentos %}
                    <h5>Equipamentos:</h5>
                    <table class="table table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Número de Série</th>
                                <th>Marca/Modelo</th>
                                <th>Valor</th>
                                <th>Estado de Entrega</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in itens_termo %}
                            <tr>
                                <td>{{ item.equipamento.numero_serie }}</td>
                                <td>{{ item.equipamento.marca }} {{ item.equipamento.modelo }}</td>
                                <td>R$ {{ item.equipamento.valor }}</td>
                                <td>{{ item.estado_entrega }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                    
                    <!-- Botão para abrir o modal de assinatura -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAssinatura">
                            Assinar Termo
                        </button>
                        <a href="{% url 'documents:termo_detail' uuid=termo.uuid %}" class="btn btn-secondary">Voltar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Assinatura -->
<div class="modal fade" id="modalAssinatura" tabindex="-1" aria-labelledby="modalAssinaturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAssinaturaLabel">Dados para Assinatura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="post" id="formAssinatura">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="alert alert-info">
                        Para concluir a assinatura do termo, por favor preencha os dados abaixo:
                    </p>
                    
                    <!-- Dados Pessoais -->
                    <h5>Dados Pessoais</h5>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="nome_completo" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="nome_completo" name="nome_completo" value="{{ dados_colaborador.nome_completo }}" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="cpf" class="form-label">CPF *</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" value="{{ dados_colaborador.cpf }}" maxlength="14" required>
                            <div class="invalid-feedback" id="cpf-feedback">
                                CPF inválido.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="rg" class="form-label">RG *</label>
                            <input type="text" class="form-control" id="rg" name="rg" value="{{ dados_colaborador.rg }}" required>
                        </div>
                    </div>
                    
                    <!-- Endereço -->
                    <h5>Endereço</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="cep" class="form-label">CEP *</label>
                            <input type="text" class="form-control" id="cep" name="cep" value="{{ dados_colaborador.cep }}" maxlength="9" required>
                        </div>
                        <div class="col-md-8">
                            <label for="endereco" class="form-label">Endereço *</label>
                            <input type="text" class="form-control" id="endereco" name="endereco" value="{{ dados_colaborador.endereco }}" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="numero" class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero" name="numero" value="{{ dados_colaborador.numero }}">
                        </div>
                        <div class="col-md-4">
                            <label for="complemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="complemento" name="complemento" value="{{ dados_colaborador.complemento }}">
                        </div>
                        <div class="col-md-5">
                            <label for="bairro" class="form-label">Bairro *</label>
                            <input type="text" class="form-control" id="bairro" name="bairro" value="{{ dados_colaborador.bairro }}" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="cidade" class="form-label">Cidade *</label>
                            <input type="text" class="form-control" id="cidade" name="cidade" value="{{ dados_colaborador.cidade }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="estado" class="form-label">Estado *</label>
                            <select class="form-select" id="estado" name="estado" required>
                                <option value="">Selecione...</option>
                                <option value="AC" {% if dados_colaborador.estado == 'AC' %}selected{% endif %}>Acre</option>
                                <option value="AL" {% if dados_colaborador.estado == 'AL' %}selected{% endif %}>Alagoas</option>
                                <option value="AP" {% if dados_colaborador.estado == 'AP' %}selected{% endif %}>Amapá</option>
                                <option value="AM" {% if dados_colaborador.estado == 'AM' %}selected{% endif %}>Amazonas</option>
                                <option value="BA" {% if dados_colaborador.estado == 'BA' %}selected{% endif %}>Bahia</option>
                                <option value="CE" {% if dados_colaborador.estado == 'CE' %}selected{% endif %}>Ceará</option>
                                <option value="DF" {% if dados_colaborador.estado == 'DF' %}selected{% endif %}>Distrito Federal</option>
                                <option value="ES" {% if dados_colaborador.estado == 'ES' %}selected{% endif %}>Espírito Santo</option>
                                <option value="GO" {% if dados_colaborador.estado == 'GO' %}selected{% endif %}>Goiás</option>
                                <option value="MA" {% if dados_colaborador.estado == 'MA' %}selected{% endif %}>Maranhão</option>
                                <option value="MT" {% if dados_colaborador.estado == 'MT' %}selected{% endif %}>Mato Grosso</option>
                                <option value="MS" {% if dados_colaborador.estado == 'MS' %}selected{% endif %}>Mato Grosso do Sul</option>
                                <option value="MG" {% if dados_colaborador.estado == 'MG' %}selected{% endif %}>Minas Gerais</option>
                                <option value="PA" {% if dados_colaborador.estado == 'PA' %}selected{% endif %}>Pará</option>
                                <option value="PB" {% if dados_colaborador.estado == 'PB' %}selected{% endif %}>Paraíba</option>
                                <option value="PR" {% if dados_colaborador.estado == 'PR' %}selected{% endif %}>Paraná</option>
                                <option value="PE" {% if dados_colaborador.estado == 'PE' %}selected{% endif %}>Pernambuco</option>
                                <option value="PI" {% if dados_colaborador.estado == 'PI' %}selected{% endif %}>Piauí</option>
                                <option value="RJ" {% if dados_colaborador.estado == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
                                <option value="RN" {% if dados_colaborador.estado == 'RN' %}selected{% endif %}>Rio Grande do Norte</option>
                                <option value="RS" {% if dados_colaborador.estado == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
                                <option value="RO" {% if dados_colaborador.estado == 'RO' %}selected{% endif %}>Rondônia</option>
                                <option value="RR" {% if dados_colaborador.estado == 'RR' %}selected{% endif %}>Roraima</option>
                                <option value="SC" {% if dados_colaborador.estado == 'SC' %}selected{% endif %}>Santa Catarina</option>
                                <option value="SP" {% if dados_colaborador.estado == 'SP' %}selected{% endif %}>São Paulo</option>
                                <option value="SE" {% if dados_colaborador.estado == 'SE' %}selected{% endif %}>Sergipe</option>
                                <option value="TO" {% if dados_colaborador.estado == 'TO' %}selected{% endif %}>Tocantins</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Estado dos Equipamentos -->
                    {% if equipamentos %}
                    <h5>Estado dos Equipamentos</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Equipamento</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in itens_termo %}
                                <tr>
                                    <td>{{ item.equipamento.marca }} {{ item.equipamento.modelo }} ({{ item.equipamento.numero_serie }})</td>
                                    <td>
                                        <select class="form-select form-select-sm" name="estado_{{ item.equipamento.id }}">
                                            <option value="Novo" {% if item.estado_entrega == 'Novo' %}selected{% endif %}>Novo</option>
                                            <option value="Usado - Bom" {% if item.estado_entrega == 'Usado - Bom' %}selected{% endif %}>Usado - Bom</option>
                                            <option value="Usado - Regular" {% if item.estado_entrega == 'Usado - Regular' %}selected{% endif %}>Usado - Regular</option>
                                            <option value="Usado - Ruim" {% if item.estado_entrega == 'Usado - Ruim' %}selected{% endif %}>Usado - Ruim</option>
                                        </select>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Assinar Termo</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Validação de CPF
        const cpfInput = document.getElementById('cpf');
        if (cpfInput) {
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value;
                value = value.replace(/\D/g, '');
                
                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{0,3})/, '$1.$2');
                }
                
                e.target.value = value;
                
                // Validação simples
                if (value.length === 14) {
                    let valid = validarCPF(value.replace(/\D/g, ''));
                    if (!valid) {
                        cpfInput.classList.add('is-invalid');
                        document.getElementById('cpf-feedback').style.display = 'block';
                    } else {
                        cpfInput.classList.remove('is-invalid');
                        document.getElementById('cpf-feedback').style.display = 'none';
                    }
                }
            });
        }
        
        // Função para validar CPF
        function validarCPF(cpf) {
            if (cpf.length !== 11) return false;
            
            if (/^(\d)\1+$/.test(cpf)) return false;
            
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            
            let resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;
            
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            
            resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(10))) return false;
            
            return true;
        }
        
        // Busca de endereço pelo CEP
        const cepInput = document.getElementById('cep');
        if (cepInput) {
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value;
                value = value.replace(/\D/g, '');
                
                if (value.length > 5) {
                    value = value.replace(/(\d{5})(\d{0,3})/, '$1-$2');
                }
                
                e.target.value = value;
                
                if (value.length === 9) {
                    buscarEnderecoPorCEP(value);
                }
            });
        }
        
        function buscarEnderecoPorCEP(cep) {
            cep = cep.replace(/\D/g, '');
            
            if (cep.length !== 8) return;
            
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('endereco').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                        document.getElementById('cidade').value = data.localidade;
                        document.getElementById('estado').value = data.uf;
                        // Foca no campo número após preencher o endereço
                        document.getElementById('numero').focus();
                    }
                })
                .catch(error => console.error('Erro ao buscar CEP:', error));
        }
        
        // Validação do formulário antes de enviar
        const form = document.getElementById('formAssinatura');
        if (form) {
            form.addEventListener('submit', function(e) {
                let valid = true;
                
                // Validar CPF
                const cpf = cpfInput.value.replace(/\D/g, '');
                if (!validarCPF(cpf)) {
                    cpfInput.classList.add('is-invalid');
                    document.getElementById('cpf-feedback').style.display = 'block';
                    valid = false;
                }
                
                if (!valid) {
                    e.preventDefault();
                }
            });
        }
    });
</script>
{% endblock %} 