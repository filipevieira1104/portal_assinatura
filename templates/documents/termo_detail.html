{% extends 'base.html' %}

{% block title %}Detalhes do Termo de Responsabilidade{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h2>Termo de Responsabilidade</h2>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <h5>Detalhes do Termo</h5>
                    <p><strong>Colaborador:</strong> {{ termo.colaborador.get_full_name }}</p>
                    <p><strong>Status:</strong> {{ termo.get_status_display }}</p>
                    <p><strong>Data de Envio:</strong> {{ termo.data_envio|date:"d/m/Y"|default:"Não enviado" }}</p>
                    <p><strong>Data de Assinatura:</strong> {{ termo.data_assinatura|date:"d/m/Y"|default:"Não assinado" }}</p>
                </div>
                <div class="col-md-6">
                    <h5>Equipamentos</h5>
                    <ul>
                        {% for item in termo.itemtermo_set.all %}
                        <li>{{ item.equipamento.marca }} {{ item.equipamento.modelo }} ({{ item.equipamento.numero_serie }})</li>
                        {% empty %}
                        <li>Nenhum equipamento associado</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            
            <hr>
            
            <div class="row">
                <div class="col-12">
                    <h5>Conteúdo do Termo</h5>
                    <div class="border p-3">
                        {{ conteudo_documento|safe }}
                    </div>
                </div>
            </div>
            
            {% if pode_assinar %}
            <hr>
            <div class="row">
                <div class="col-12">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="concordo" required>
                        <label class="form-check-label" for="concordo">
                            Declaro que li e concordo com os termos e condições acima.
                        </label>
                    </div>
                    <button type="button" class="btn btn-success" id="btnAbrirModal" disabled>Assinar Termo</button>
                </div>
            </div>
            {% endif %}
            
            {% if termo.status == 'ASSINADO' and termo.arquivo_pdf %}
            <hr>
            <div class="row">
                <div class="col-12">
                    <a href="{% url 'documents:termo_download' termo.uuid %}" class="btn btn-primary">
                        <i class="fas fa-download"></i> Download do Termo Assinado
                    </a>
                </div>
            </div>
            {% endif %}
            
            <div class="row mt-3">
                <div class="col-12">
                    <a href="{% url 'documents:termo_list' %}" class="btn btn-secondary">Voltar para a lista</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para coleta de dados do usuário -->
<div class="modal fade" id="modalDadosUsuario" tabindex="-1" aria-labelledby="modalDadosUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDadosUsuarioLabel">Informações para Assinatura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="post" action="{% url 'documents:termo_sign' termo.uuid %}" id="formAssinatura">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="alert alert-info">Por favor, preencha os dados abaixo para completar a assinatura do termo.</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" required>
                        </div>
                        <div class="col-md-6">
                            <label for="rg" class="form-label">RG</label>
                            <input type="text" class="form-control" id="rg" name="rg" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="endereco" class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="endereco" name="endereco" required>
                        </div>
                        <div class="col-md-3">
                            <label for="numero" class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero" name="numero" required>
                        </div>
                        <div class="col-md-3">
                            <label for="complemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="complemento" name="complemento">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="bairro" class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="bairro" name="bairro" required>
                        </div>
                        <div class="col-md-4">
                            <label for="cidade" class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade" name="cidade" required>
                        </div>
                        <div class="col-md-2">
                            <label for="estado" class="form-label">Estado</label>
                            <input type="text" class="form-control" id="estado" name="estado" required maxlength="2">
                        </div>
                        <div class="col-md-2">
                            <label for="cep" class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cep" name="cep" required>
                        </div>
                    </div>
                    
                    <h5 class="mt-4">Detalhes dos Equipamentos</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Equipamento</th>
                                    <th>Nº de Série</th>
                                    <th>Estado de Entrega</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in termo.itemtermo_set.all %}
                                <tr>
                                    <td>{{ item.equipamento.marca }} {{ item.equipamento.modelo }}</td>
                                    <td>{{ item.equipamento.numero_serie }}</td>
                                    <td>
                                        <input type="text" class="form-control" name="estado_{{ item.equipamento.id }}" value="{{ item.estado_entrega }}" required>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar e Assinar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const concordoCheckbox = document.getElementById('concordo');
        const btnAbrirModal = document.getElementById('btnAbrirModal');
        
        // Habilitar/desabilitar botão de assinar conforme checkbox
        if (concordoCheckbox && btnAbrirModal) {
            concordoCheckbox.addEventListener('change', function() {
                btnAbrirModal.disabled = !this.checked;
            });
            
            // Abrir modal ao clicar no botão
            btnAbrirModal.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('modalDadosUsuario'));
                modal.show();
            });
        }
        
        // Máscara para CPF e CEP
        const cpfInput = document.getElementById('cpf');
        if (cpfInput) {
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                
                if (value.length > 9) {
                    value = value.replace(/^(\d{3})(\d{3})(\d{3})/, '$1.$2.$3-');
                } else if (value.length > 6) {
                    value = value.replace(/^(\d{3})(\d{3})/, '$1.$2.');
                } else if (value.length > 3) {
                    value = value.replace(/^(\d{3})/, '$1.');
                }
                
                e.target.value = value;
            });
        }
        
        const cepInput = document.getElementById('cep');
        if (cepInput) {
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 8) value = value.substring(0, 8);
                
                if (value.length > 5) {
                    value = value.replace(/^(\d{5})(\d{3})/, '$1-$2');
                }
                
                e.target.value = value;
            });
        }
    });
</script>
{% endblock %}
